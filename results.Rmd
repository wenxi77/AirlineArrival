# Results

We want to first have a general idea of what elements would possibly influence the airplane to delay, based on the data we have. The elements we investigate below are different airlines, quarters of a year, and departure/arrival states.

## delay or not
```{r}
library(dplyr)
library(grid)
library(RColorBrewer)
df <- read.csv(file='pre-processed data/2018-2021.csv')
df <- df[-c(1,2)]

```



Since we want to investigate the general trend of delay correlated with different time of a year (quarters) and different airlines, here we pick the top 5 airlines that appear most during 2018-2021 in our data set. They are AA (American Airlines), DL (Delta Air Lines), OO (SkyWest Airlines), UA (	United Air Lines), WN (Southwest Airlines). Below the mosaic plot shows the relationship between arrival delay or not, the 5 airlines and quarters.

```{r}
library(forcats)
top5 <- df%>%  group_by(OP_UNIQUE_CARRIER)%>% count(sort = TRUE)%>%head(5)%>%select(OP_UNIQUE_CARRIER)
top5_df <- df %>%transmute(Airlines = OP_UNIQUE_CARRIER, Status = ifelse(df$ARR_DEL15==1,'delay','not delay'), Quarter = QUARTER)%>% filter(Airlines %in% c(top5$OP_UNIQUE_CARRIER))

top5_df$Status <- fct_relevel(top5_df$Status, "not delay")
vcd::mosaic( Status ~ Airlines + Quarter,top5_df,
            direction = c("v", "v", "h"), highlighting_fill= RColorBrewer::brewer.pal(8, "Paired"))
```

From the plot we may see that for the 5 airlines with most flights in our data set, the third quarter has the highest proportion of delay. Except for Southwest Airlines, the other four airlines show apparent increase in delay in the third quarter. This could be caused by extreme weather like Thunderstorms, which most likely to happen in summer, according to [National Weather Service](https://www.weather.gov/media/grr/brochures/nwsthunderstorms&lightning.pdf).




Next, let's look at how departure states affects departure delay.
Below the map visualize the average departure delay minutes for every flight departs from some state.

```{r, warning=FALSE,fig.width = 10}
library(dplyr)
library(tidyr)
library(tibble)
library(ggplot2)
library(choroplethr)
library(choroplethrMaps)


dep_delay <- df %>% select(c('ORIGIN_STATE_NM','DEP_DELAY'))%>%transmute(region = tolower(ORIGIN_STATE_NM), value = DEP_DELAY)

dep_map <- na.omit(dep_delay)%>%group_by(region)%>%summarise(value=mean(value),
            .groups = 'drop')
state_choropleth(dep_map,title = " Departure State average delay in minutes", legend='average delay (minutes)')

                  
```



Similarly, we visualize the average arrival delay minutes for every flight arrive some state.
```{r,warning=FALSE,fig.width = 10}
arr_delay <- df %>% select(c('DEST_STATE_NM','ARR_DELAY'))%>%transmute(region = tolower(DEST_STATE_NM), value = ARR_DELAY)
arr_map <- na.omit(arr_delay)%>%group_by(region)%>%summarise(value=mean(value),
            .groups = 'drop')
state_choropleth(arr_map,title = " Arrival State average delay in minutes", legend='average delay (minutes)')
```

We may notice that flights both from and to north eastern parts of the US like New York are most likely to delay. As for the states that flights depart, the middle parts and north eastern parts of the US are more likely to delay. For the states that flights arrive, both the southern part and north eastern part are more likely to delay.


## Exploratory data analysis on flights' delay time:

This section focuses on the flights' delay time. We want to visualize some relationship between a flight's delay time and factors like the airline this flight belong to, the time in terms of month, quarter, or year this flight departures at, and this flight's departure performance.

**Heat map for average delay time of different airline company and different quarters in year:**

The first plot will be a heat map with x-axis being different airlines and y-axis being different in years. Then each rectangle in the plot represents the average delay time of the flights belong to this airline company at this quarter in year.  
We use the unique carrier code for each airline company since that's the data provided by BTS. Then we will refer those code to their corresponding airline company when analyze the result.  
The reason we pick quarter in year to be our y-axis is that we believe the delay time is likely related to the whether condition, and the whether condition tends to vary quarter by quarter.  
After quick explore of the data, we found that the average delay time has range from -5 to 15, and we decided to use color blue to represent -5 and color red to represent 15. Notice that a negative number of delay time of a flight means it arrived earlier.  
For better visualization, we also decided to present the average delay time as a number in each rectangular. 

```{r}
# Import Data Set
library(ggplot2)
library(dplyr)
df <- read.csv(file='pre-processed data/2018-2021.csv')
df <- df[-c(1,2)]
```

```{r}
carriers <- unique(df[,'OP_UNIQUE_CARRIER'])
num_carriers <- length(carriers)
delay_time <- df[,'ARR_DELAY']
df_delay_time <- df[!is.na(df$ARR_DELAY), ]

df_delay_time_carrier_quarter <- df_delay_time %>%
  group_by(OP_UNIQUE_CARRIER, QUARTER) %>%
  summarize(delay_time_mean = mean(ARR_DELAY), .groups = 'drop')
```

```{r, fig.width = 10}
theme_heat <- theme_classic() + 
  theme(axis.line = element_blank(), axis.ticks = element_blank()) 
ggplot(data = df_delay_time_carrier_quarter, mapping = aes(x = OP_UNIQUE_CARRIER, y = QUARTER)) +
  geom_tile(aes(fill = delay_time_mean), color = 'white') +
  scale_fill_distiller(palette = "RdBu") +
  geom_text(aes(label = round(delay_time_mean, 1)), color = "black") +
  ggtitle('Heatmap for Average Delay Time of Different Airlines in Different Quarters') + 
  xlab('Airline (Carrier)') +
  ylab('Quarter in Year') +
  guides(fill = guide_legend(title = 'Average Delay Time')) + 
  theme_heat
```

There are four noticeable results appeared on the heat map above:  
1. The airline company VX(Virgin America) only has the flights on the first quarter of each year, which is from January to March.  
2. The top3 performance in terms of average delay time are: 1.AS(Alaska Airline) on the second quarter with arrive 5.6 minutes earlier on average. 2.YX(Republic Airline) on the second quarter with arrive 4.3 minutes earlier on average. 3.9E(Endeavor Air) on the second quarter with arrive 4.1 minutes earlier on average.  
3. The worst3 performance in terms of average delay time are: 1.YV(Mesa Airline) on the fourth quarter with arrive 16 minutes late on average. 2.F9(Frontier Airline) on the third quarter with arrive 14.3 minutes late on average. 3.G4(Allegiant Air) on the third quarter with arrive 13.8 minutes late on average.  
4. The first quarter and the second quarter tend to have color more blue, while the third quarter and the fourth quarter tend to have color more red. Combine with the result2 that all top3 happened on the second quarter and the result3 that all worst3 happened on either the third quarter or the fourth quarter. It seems like flights tend to delay more on the second half of a year.

**Ridge line plots for average delay time of best airline company and different quarters in year:**

The heat map above tells us the flights' average delay time of different airline company in different quarters of a year. Thus we can easily pick the best airline company in a given quarter in terms of the average delay time. However, we believe that the distribution of delay time is also important, and can in fact provide additional useful information for us. For example, if two airline company have the same average delay time, but one is more spread out than another. Then this one will be consider a little bit worse than the another one.  
We decide to use ridge line to present the distribution of delay time of different airline company in different quarters of year. Since we have 19 different airline company, and put them all together in one ridge plot makes the plot too big to visualize, we decided to choose two airline company that performed the best in terms of delay time in each quarter. Also, for better visualization, we removed all outliers since there are few outliers for each airline that doesn't really affect the distribution but are much larger than other numbers.

```{r, warning=FALSE, message=FALSE}
library(ggridges)
df_delay_time[df_delay_time$QUARTER == 1, "QUARTER"] <- 'First Quarter'
df_delay_time[df_delay_time$QUARTER == 2, "QUARTER"] <- 'Second Quarter'
df_delay_time[df_delay_time$QUARTER == 3, "QUARTER"] <- 'Third Quarter'
df_delay_time[df_delay_time$QUARTER == 4, "QUARTER"] <- 'Fourth Quarter'
df_delay_time$QUARTER_f <- factor(df_delay_time$QUARTER, levels = c('First Quarter', 'Second Quarter', 'Third Quarter', 'Fourth Quarter'))
ggplot(data = df_delay_time[df_delay_time$OP_UNIQUE_CARRIER == '9E' | df_delay_time$OP_UNIQUE_CARRIER == 'AS' | df_delay_time$OP_UNIQUE_CARRIER == 'YX' | df_delay_time$OP_UNIQUE_CARRIER == 'HA' | df_delay_time$OP_UNIQUE_CARRIER == 'QX', ], mapping = aes(x = ARR_DELAY, y = OP_UNIQUE_CARRIER, fill = stat(x))) +
  geom_density_ridges_gradient(outlier.shape = NA) +
  scale_x_continuous(limits = quantile(df_delay_time$ARR_DELAY, c(0.1, 0.9))) +
  scale_fill_viridis_c(name = "Average Delay Time") +
  ggtitle('Ridgeline for Average Delay Time of Best Airlines in Different Quarters') +
  xlab('Average Delay Time') +
  ylab('Airline (Carrier)') +
  facet_wrap(~QUARTER_f)
```

For the first quarter, airline company 9E(Endeavor Air) seems to perform the best with most of delay time below 0 and center around -12. That means if one travel decides to pick Endeavor Air at first quarter, then he/she is likely to arrive earlier than expected.  
For the second quarter, although airline company AS(Alaska Airline) has lower average delay time than 9E(Endeavor Air) in heat map, 9E(Endeavor Air) seems to have better performance showed by ridge line.  
For the third quarter, airline company QX(Horizon Air) seems to perform the best with the most of delay time center around -10. This result is aligned with heat map.  
For the fourth quarter, airline company 9E(Endeavor Air) again seems to perform the best with the distribution tends to normal with mean around -11. Although 9E(Endeavor Air) doesn't have the lowest average delay time in heat map, it distribution showed by ridge line is the best.





